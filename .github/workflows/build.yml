name: Build Swift Playgrounds App

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    env:
      APP_NAME: Ai Studio   # الاسم الجديد للتطبيق
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.4'

      - name: Unzip Project
        run: unzip "Ai Studio.zip"

      - name: Show available schemes (verify)
        run: |
          if [ -d "Ai Studio.swiftpm" ]; then
            cd "Ai Studio.swiftpm"
            echo "داخل مجلد Ai Studio.swiftpm — أظهر الـ schemes المتاحة:"
            xcodebuild -list || true
            cd ..
          else
            echo "لم أجد مجلد Ai Studio.swiftpm؛ أدرج محتويات المستودع:"
            ls -la
            exit 1
          fi

      - name: Build and Archive
        run: |
          APP_NAME="${APP_NAME:-Ai Studio}"
          if [ -d "Ai Studio.swiftpm" ]; then
            cd "Ai Studio.swiftpm"
            mkdir -p ../build
            echo "بادئ البناء والأرشفة للاسم: $APP_NAME"
            xcodebuild -scheme "$APP_NAME" \
              -destination 'generic/platform=iOS' \
              -sdk iphoneos \
              -configuration Release \
              -archivePath ../build/"$APP_NAME".xcarchive \
              archive \
              CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO
            cd ..
          else
            echo "لا يمكن البناء: لم أجد مجلد Ai Studio.swiftpm"
            exit 1
          fi

      - name: Show archive contents (debug)
        run: |
          APP_NAME="${APP_NAME:-Ai Studio}"
          ARCHIVE="build/$APP_NAME.xcarchive"
          echo "تفاصيل الأرشيف: $ARCHIVE"
          if [ -d "$ARCHIVE" ]; then
            ls -la "$ARCHIVE"
            echo "داخل Products/Applications:"
            ls -la "$ARCHIVE/Products/Applications" || true
          else
            echo "الأرشيف غير موجود."
          fi

      - name: Create unsigned IPA (for signing later with ksign)
        run: |
          APP_NAME="${APP_NAME:-Ai Studio}"
          ARCHIVE="build/$APP_NAME.xcarchive"
          # البحث التلقائي عن ملف .app داخل الأرشيف
          APP_PATH=$(find "$ARCHIVE/Products/Applications" -name "*.app" | head -n 1)

          if [ -d "$APP_PATH" ]; then
            echo "وجدت التطبيق داخل الأرشيف: $APP_PATH"
            rm -rf build/Payload
            mkdir -p build/Payload
            cp -R "$APP_PATH" build/Payload/
            # إنشاء ملف IPA بالاسم الجديد
            (cd build && zip -r "Ai-Studio-unsigned.ipa" Payload)
            echo "تم إنشاء build/Ai-Studio-unsigned.ipa"
          else
            echo "خطأ: لم أجد التطبيق داخل الأرشيف"
            exit 1
          fi

      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Ai-Studio-IPA
          path: build/*.ipa
